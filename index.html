<!DOCTYPE HTML>
<html>
<head>
    <title>Cloud Platforms</title>
    <meta charset="utf-8">
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <script src="js/constants.js"></script>
    <script src="js/level.js"></script>
    <script src="js/create.js"></script>
</head>
<body>

    <div id="game"></div>

    <script type="text/javascript">

    var game = new Phaser.Game(GAME_CANVAS_WIDTH, GAME_CANVAS_HEIGHT, Phaser.AUTO, 'game');

    //globals
    var background = null,
        trees = null,
        player = null,
        blocks = null,
        gameOverText = null,
        jumpKey = null;

    var trigger, blockNumber;

    var PhaserGame = function () {};
    PhaserGame.prototype = {

        init: function () {
            this.world.resize(GAME_CANVAS_WIDTH*2, GAME_CANVAS_HEIGHT);
        },

        preload: function () {
            this.load.crossOrigin = 'anonymous';

            this.load.image('trees', 'assets/trees-h.png');
            this.load.image('background', 'assets/clouds-h.png');
            this.load.image('block', 'assets/block.png');
            this.load.image('deadblock', 'assets/deadlyblock.png');
            this.load.spritesheet('dude', 'assets/dude.png', PLAYER_WIDTH, PLAYER_HEIGHT);
        },

        create: function () {
            create.background();
            create.player();
            create.level();

            //controls.
            jumpKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
            game.input.keyboard.addKeyCapture(Phaser.Keyboard.SPACEBAR);
        },

        update: function () {
            background.tilePosition.x = -(this.camera.x * 0.7);
            trees.tilePosition.x = -(this.camera.x * 0.9);

            this.physics.arcade.overlap(player, blocks, this.gameOver, null, this);
            if (Phaser.Line.intersects(new Phaser.Line(player.x, player.y, player.x + PLAYER_WIDTH, player.y), trigger)) {
                level[blockNumber].onTrigger();
                blockNumber++;
                if (blockNumber > level.length) {
                    return;
                }

                trigger = new Phaser.Line(level[blockNumber].triggerX, 0, level[blockNumber].triggerX, GAME_CANVAS_WIDTH);
            }

            if (jumpKey.isDown && player.body.y >= GAME_CANVAS_HEIGHT-PLAYER_HEIGHT)
            {
                player.body.velocity.y = PLAYER_JUMP_VELOCITY;
            }
        },

        gameOver: function (player, block) {
            //  Add and update the score
            player.body.velocity.x = 0;
            player.x -= 5;
            player.play('stop');
            gameOverText = game.add.text(player.x, game.world.height/2, '', { fontSize: '52px', fill: '#000' });
            gameOverText.text = 'GAME OVER';
        }

    };

    game.state.add('Game', PhaserGame, true);

    </script>

</body>
</html>